name: Demand Forecast CI

on:
  push:
    branches: [ main, master ]

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    
    env:
      MLFLOW_TRACKING_USERNAME: ${{ secrets.DAGSHUB_USERNAME }}
      MLFLOW_TRACKING_PASSWORD: ${{ secrets.ABARK_MLOPS }}
      ABARK_MLOPS: ${{ secrets.ABARK_MLOPS }}
      DAGSHUB_PAT: ${{ secrets.ABARK_MLOPS }}
      DAGSHUB_USER_TOKEN: ${{ secrets.ABARK_MLOPS }}
      DAGSHUB_TOKEN: ${{ secrets.ABARK_MLOPS }}
    
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest flake8

    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

    - name: Run Unit Tests
      run: |
        pytest tests/test_preprocessing.py

    - name: Run API Integration Tests
      run: |
        pytest tests/test_api.py

    - name: Run Model Validation Tests
      run: |
        pytest tests/test_model_validation.py

    - name: Validate DVC Pipeline
      run: |
        dvc dag
        echo "DVC Pipeline DAG is valid."

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: us-east-1

    - name: Pull Data from DVC (S3)
      run: |
        dvc remote add -d -f s3remote s3://ecomerces3bucket
        dvc remote modify s3remote region us-east-1
        dvc pull data/processed/processed.csv models/scaler.joblib

    - name: Login to AWS ECR
      if: success()
      run: |
        aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 490004640299.dkr.ecr.eu-north-1.amazonaws.com

    - name: Build Docker image
      if: success()
      run: |
        docker build -t ecommerce_ecr .

    - name: Tag Docker image
      if: success()
      run: |
        docker tag ecommerce_ecr:latest 490004640299.dkr.ecr.eu-north-1.amazonaws.com/ecommerce_ecr:latest

    - name: Push Docker image to AWS ECR
      if: success()
      run: |
        docker push 490004640299.dkr.ecr.eu-north-1.amazonaws.com/ecommerce_ecr:latest
    - name: Deploy to EC2
      if: success()
      uses: appleboy/ssh-action@v0.1.5
      with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            aws configure set aws_access_key_id ${{ secrets.AWS_ACCESS_KEY_ID }}
            aws configure set aws_secret_access_key ${{ secrets.AWS_SECRET_ACCESS_KEY }}
            aws configure set default.region eu-north-1
            aws ecr get-login-password --region eu-north-1 | docker login --username AWS --password-stdin 490004640299.dkr.ecr.eu-north-1.amazonaws.com
            docker pull 490004640299.dkr.ecr.eu-north-1.amazonaws.com/ecommerce_ecr:latest
            docker stop ecommerce_ecr || true
            docker rm ecommerce_ecr || true
            docker run -d -p 8501:8501 -p 8000:8000 --env DAGSHUB_PAT="${{ secrets.ABARK_MLOPS }}" --name ecommerce_ecr --restart always 490004640299.dkr.ecr.eu-north-1.amazonaws.com/ecommerce_ecr:latest

    
